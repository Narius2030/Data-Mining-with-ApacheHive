-- Database
CREATE DATABASE sakila_dwh;use

-- Rental Dimension
CREATE TABLE Dim_Rental (
    rental_key INT,
    rental_id INT,
    rental_date DATE,
    inventory_id INT,
    customer_id INT,
    return_date DATE,
    staff_id INT,
    amount FLOAT,
    payment_date DATE
)
CLUSTERED BY (rental_id) INTO 8 BUCKETS
ROW FORMAT DELIMITED FIELDS TERMINATED BY ','
STORED AS TEXTFILE;

-- Customer Dimension
CREATE TABLE Dim_Customer (
    customer_key INT,
    customer_id INT,
    store_id INT,
    address_id INT,
    active INT,
    full_name string,
    city string,
    country string
)
CLUSTERED BY (customer_id) INTO 6 BUCKETS
ROW FORMAT DELIMITED FIELDS TERMINATED BY ','
STORED AS TEXTFILE;

-- Fact Segment
CREATE TABLE Fact_Segment (
    customer_id INT,
    city string,
    country string,
    active TINYINT,
    full_name string,
    rental_id INT,
    amount FLOAT,
    rental_date DATE,
    first_date DATE,
    recency INT,
    monetary FLOAT,
    frequency INT
)
CLUSTERED BY (customer_id) INTO 8 BUCKETS
ROW FORMAT DELIMITED FIELDS TERMINATED BY ','
STORED AS TEXTFILE;

-- Load data into dimension and fact tables

--## Load into rental and customer dimensions
LOAD DATA LOCAL INPATH 'C:/Education/Uni/BigData/Final_Project/Data-Mining-with-ApacheHive/data/tables/dimCustomer.csv' OVERWRITE INTO TABLE Dim_Customer;
LOAD DATA LOCAL INPATH 'C:/Education/Uni/BigData/Final_Project/Data-Mining-with-ApacheHive/data/tables/dimRental.csv' OVERWRITE INTO TABLE Dim_Rental;

--## Load into Fact_Segment fact table
INSERT INTO TABLE Fact_Segment
SELECT
    c.customer_id, c.city, c.country, c.active, c.full_name,
    r.rental_id, r.amount, r.rental_date,
    (SELECT MIN(rental_date) FROM Dim_Rental sub_r WHERE sub_r.customer_id = c.customer_id) AS first_date,
    DATEDIFF(
        (SELECT MAX(rental_date) FROM Dim_Rental sub_r WHERE sub_r.customer_id = c.customer_id),
        (SELECT MIN(rental_date) FROM Dim_Rental sub_r WHERE sub_r.customer_id = c.customer_id)
    ) AS recency,
    (SELECT SUM(amount) FROM dim_rental sub_r WHERE sub_r.customer_id = c.customer_id) AS monetary,
    (SELECT COUNT(rental_id) FROM dim_rental sub_r WHERE sub_r.customer_id = c.customer_id) AS frequency
FROM dim_customer c
JOIN dim_rental r ON r.customer_id = c.customer_id